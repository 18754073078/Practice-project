/*=========================================================================\
* Copyright(C)2016 Chudai.
*
* File name    : client.c
* Version      : v1.0.0
* Author       : 初代
* Date         : 2016/08/23
* Description  :
* Function list: 1.
*                2.
*                3.
* History      :
\*=========================================================================*/

/*-----------------------------------------------------------*
 * 头文件                                                    *
 *-----------------------------------------------------------*/
#include "comm_inc.h"
#include "wrap_error.h"
#include "wrap_sock.h"
#include "client.h"
#include "child.h"


int main(void)
{
    int         i = 0;
    int         j = 0;
    int         status = 0;
    int         all_porc = MAX_IP * IPTOPROC;
    child_arg_s args;
    pid_t       pid[MAX_IP * IPTOPROC];
    char        ip_array[MAX_IP][20] = // "192.168.1.10,192.168.1.11,192.168.1.12,192.168.1.13,192.168.1.14,192.168.1.15,192.168.1.16,192.168.1.17,192.168.1.18,192.168.1.19,";
                                {"192.168.1.10", "192.168.1.11",
                                "192.168.1.12", "192.168.1.13",
                                "192.168.1.14", "192.168.1.15",
                                "192.168.1.16", "192.168.1.17",
                                "192.168.1.18", "192.168.1.19",
                                "192.168.1.30", "192.168.1.31",
                                "192.168.1.32", "192.168.1.33",
                                "192.168.1.34", "192.168.1.35",
                                "192.168.1.36", "192.168.1.37",
                                "192.168.1.38", "192.168.1.39",
                                "192.168.1.40", "192.168.1.41",
                                "192.168.1.42", "192.168.1.43",
                                "192.168.1.44", "192.168.1.45",
                                "192.168.1.46", "192.168.1.47",
                                "192.168.1.48", "192.168.1.49",
                                "192.168.1.50", "192.168.1.51",
                                "192.168.1.52", "192.168.1.53",
                                "192.168.1.54", "192.168.1.55",
                                "192.168.1.56", "192.168.1.57",
                                "192.168.1.58", "192.168.1.59",};


    //一个ip开10个进程，10个ip开100个进程，每个进程处理1000个连接。
    for (i = 0; i < MAX_IP; i++)
    {
        args.childnum = i * MAX_IP;
        memcpy(args.ip, ip_array[i], strlen(ip_array[i])+1);          //设定客户端IP
//        printf("ip = %s\n", args.ip);

        for (j = 0; j < IPTOPROC; j++)
        {
            args.childnum += j;
            create_process(&pid[args.childnum], child_process, (void*)&args);
        }
        sleep(1);
    }

    for (i = 0; i < all_porc; i++)
    {
        if (waitpid(-1, &status, WNOHANG) == 0)
        {
            sleep(1);
        }
    }

    return 0;
}
