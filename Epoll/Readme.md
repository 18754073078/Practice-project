##高并发编程：  
这个代码中，服务器程序开多个进程，等待客户端连接。  

##下一个版本：  
* 改进：进程一个一个开，需要的时候再开。  
* 实现断开连接的功能。  

注意：  
* 因为想着尽量不修改系统参数，所以在客户端端口不够用的时候，都是增加IP。每个IP只开了2w多的连接。用了40个IP。  

##遇到的问题：  
###服务器：  
曾陷入的思维误区：  
* 服务器每个IP只能接受28000左右个连接，如何配置10个IP呢？一个程序如何使用多个IP呢？  
	* 错误的理解了服务器的IP：PORT也要改变。  
	* 其实四元组确定唯一一个连接，如此以来只要客户端的Ip或端口改变即可。服务器的Ip和port可以不用改变。所以服务器不是每个IP只能接受28000个连接而已！  

* 客户端发起所有连接后，我的做法是先让进程sleep()一段时间。会出现一个不知道什么原因造成的问题：连接数达到最高的时候，只停留了一会儿，就开始骤降。  
	* 原因是程序的问题。服务器的子进程本来是死循环accept()的，后来改成超过能打开的文件描述符就跳出死循环然后sleep一段时间后退出，进程退出后连接会释放，所以会骤降。  

* 伴随前一个问题的还有一个问题：就是连接数没有达到预期。例如要开40w，只开了39.93w, 总有六七百没有连接到。（50W开了49.93w）  

* 服务器在82w多点的时候，开始出现Too many open file in system.   
>修改/etc/sysctl.conf  
>添加或修改：fs.file-max = 1048576  
>然后生效：sudo sysctl -p  

* 经过计算，每个连接占用3k左右，为什么？在书上看到说至少需要8k，是因为我只建立连接没有发送信息，所以没有发送/接受缓冲区吗？  

* 为什么总是有连接无法连上？例如发起50w， 一般就只能建立49w8k左右；发起100w， 一般只能99w7k左右，为什么？如何才能减少这些不成功的连接？  
（如果是服务器开能接受100w连接，而客户端只发起50w，则一般就只有600左右没能连接成功。）  


###客户端：
* 每个Ip默认只能建立60999-32768个连接，如何修改单Ip能建立的连接数呢？
改变单个Ip的连接数：
	* 查看：
> cat /proc/sys/net/ipv4/ip_local_port_range
	* 临时修改：
> echo "1024 65535"> /proc/sys/net/ipv4/ip_local_port_range
	* 永久修改：
> 打开：/etc/sysctl.conf
> 添加：net.ipv4.ip_local_port_range= 1024 65535
> 生效：sysctl -p


* 虚拟网卡已经创建，但是如何指定连接服务器的IP呢？
	* 用bind()函数来指定端口和地址，即可实现多个connect。

* 客户端出现：connect error: Cannot assign requested address
	* 服务器此时的连接数是:28234
	* 客户端此时的连接数是：28233,处于FIN_WAIT_2状态，大概是因为此时客户端已经退出（和60999-32768差2，可能有关联)
	* 问题在于客户端而不在服务器，因为出现此问题时，服务器仍然可以再建立连接。
真正的原因是：忘记建立虚拟网卡了，所有的ip都使用了本机的IP，也就是只有一个IP。隔天后发现原因，然后C100k就很容易上去了。

* 客户端出现Too many open file in system.
	* 修改了/etc/sysctl.conf
	* 添加或修改：fs.file-max = 1048576
	* 然后生效：sudo sysctl -p
	
	
##使用的命令
* 查看一个ip的端口的使用默认范围
> cat /proc/sys/net/ipv4/ip_local_port_range 

* 查看特定端口的连接数。
> netstat -nat|grep -i "8000"|wc -l (不要后面的|wc -l就是查看连接)

* 查看系统建立的连接数量
> cat /proc/net/sockstat

* 查看内存和交换空间的使用情况：
> free -m 
> top -p8000       //端口


* 查看系统最大能打开的文件数量以及已经打开的文件数量：
> sysctl -a | grep file 

* 查看系统的运行情况：
> vmstat

* 查看tcp连接各种缓冲区的大小：
> 1. 读缓冲：（单位是字节）
> cat /proc/sys/net/ipv4/tcp_rmem
> 2. 写缓冲：（单位是字节）
> cat /proc/sys/net/ipv4/tcp_rmem
> 3. 内存大小：（单位是页：4096字节）
> cat /proc/sys/net/ipv4/tcp_rmem
> 4. 更改：
> echo "net.ipv4.tcp_mem = 786432 2097152 3145728">> /etc/sysctl.conf
> echo "net.ipv4.tcp_rmem = 4096 4096 16777216">> /etc/sysctl.conf
> echo "net.ipv4.tcp_wmem = 4096 4096 16777216">> /etc/sysctl.conf


